# 电力线分析系统 - 微服务配置说明

## 系统概述

本系统是一个基于Spring Boot的电力线分析平台，集成了六个核心微服务功能，支持激光雷达点云数据的电力线检测和分析。

## 微服务架构

### 1. 数据库读写分离微服务 ✅

**功能描述**: 实现MySQL主从数据库的读写分离，提高数据库性能和可用性。

**核心组件**:
- `DataSourceAspect.java` - 数据源切换AOP切面
- `DataSourceContextHolder.java` - 数据源上下文管理
- `DataSourceHealthCheck.java` - 数据源健康检查
- `@Master` / `@ReadOnly` 注解 - 数据源选择注解

**配置要点**:
- 主库: `192.168.108.152:3306`
- 从库1: `192.168.108.153:3306`
- 从库2: `192.168.108.154:3306`
- 支持负载均衡轮询策略

**使用示例**:
```java
@Master
public User register(UserRegisterDTO dto) {
    // 写操作使用主库
}

@ReadOnly
public User findUserByAccount(String account) {
    // 读操作使用从库
}
```

### 2. 缓存机制微服务 ✅

**功能描述**: 基于Redis的缓存系统，支持热点数据识别和智能缓存更新。

**核心组件**:
- `CacheServiceImpl.java` - 缓存服务实现
- `CacheAspect.java` - 缓存AOP切面
- `@Cacheable` 注解 - 自定义缓存注解
- `CacheController.java` - 缓存管理接口

**配置要点**:
- Redis服务器: `localhost:6379`
- 支持热点数据自动识别
- 支持缓存预热和过期清理
- 支持多种缓存策略

**使用示例**:
```java
@Cacheable(key = "'user:account:' + #account", ttl = 1800, dataType = "user")
public User findUserByAccount(String account) {
    // 自动缓存用户查询结果
}
```

### 3. 远程方法调用Java RMI微服务 ✅

**功能描述**: 将电力线分析处理封装为远程服务，支持分布式计算。

**核心组件**:
- `PowerLineAnalysisService.java` - 远程服务接口
- `PowerLineAnalysisServiceImpl.java` - 远程服务实现
- `RmiBootStarter.java` - RMI服务启动器
- `PowerLineAnalysisController.java` - RMI客户端控制器

**配置要点**:
- RMI注册中心: `192.168.181.152:1099`
- 服务端口: `20001` (HelloService), `20002` (PowerLineAnalysisService)
- 支持电力线提取、RANSAC拟合、报告生成等功能

**使用示例**:
```java
// 调用远程电力线分析服务
PowerLineAnalysisService service = getService();
Map<String, Object> result = service.processLasFile(filePath, outputDir);
```

### 4. 消息队列RabbitMQ微服务 ✅

**功能描述**: 基于RabbitMQ的异步消息处理系统，支持文件处理、通知、日志等消息类型。

**核心组件**:
- `RabbitConfig.java` - RabbitMQ配置
- `MessageProducer.java` - 消息生产者
- `MessageConsumer.java` - 消息消费者
- `FileProcessMessage.java` - 文件处理消息
- `BaseMessage.java` - 基础消息类

**配置要点**:
- RabbitMQ服务器: `localhost:5672`
- 支持直连、主题、扇出交换器
- 支持死信队列和消息重试
- 支持WebSocket实时通知

**队列配置**:
- `file.process.queue` - 文件处理队列
- `powerline.analysis.queue` - 电力线分析队列
- `notification.queue` - 通知队列
- `system.log.queue` - 系统日志队列
- `dead.letter.queue` - 死信队列

### 5. 负载均衡微服务 ✅

**功能描述**: 基于Nginx的负载均衡配置，支持多服务器负载分发。

**核心组件**:
- `nginx.conf` - Nginx配置文件
- `LoadBalancerConfig.java` - 负载均衡配置
- `LoadBalancerController.java` - 负载均衡监控

**配置要点**:
- 负载均衡器: `192.168.108.150:80`
- 后端服务器: `192.168.108.152-154:9090`
- 支持轮询、最少连接、IP哈希策略
- 支持健康检查和故障转移

**Nginx配置**:
```nginx
upstream powerline_backend {
    server 192.168.108.152:9090 weight=3;
    server 192.168.108.153:9090 weight=2;
    server 192.168.108.154:9090 weight=1;
}
```

### 6. Java组件复用微服务 ✅

**功能描述**: 提供Excel导入导出、日志管理、可视化展示等可复用组件。

**核心组件**:
- `ExcelUtil.java` - Excel导入导出工具
- `LogUtil.java` - 日志管理工具
- `VisualizationUtil.java` - 可视化工具
- `ComponentController.java` - 组件管理接口

**功能特性**:
- **Excel处理**: 支持导入导出，自动类型转换
- **日志管理**: 操作日志、性能日志、安全日志
- **可视化**: 系统概览、实时监控、图表数据生成

## 系统部署架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Nginx LB      │    │   App Server 1  │    │   App Server 2  │
│ 192.168.108.150 │────│ 192.168.108.152 │    │ 192.168.108.153 │
│     Port 80     │    │    Port 9090    │    │    Port 9090    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
                    ┌─────────────────┐
                    │   App Server 3  │
                    │ 192.168.108.154 │
                    │    Port 9090    │
                    └─────────────────┘

┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   MySQL Master  │    │   MySQL Slave1  │    │   MySQL Slave2  │
│ 192.168.108.152 │────│ 192.168.108.153 │    │ 192.168.108.154 │
│    Port 3306    │    │    Port 3306    │    │    Port 3306    │
└─────────────────┘    └─────────────────┘    └─────────────────┘

┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│     Redis       │    │    RabbitMQ     │    │   RMI Registry  │
│   localhost     │    │   localhost     │    │ 192.168.181.152 │
│    Port 6379    │    │    Port 5672    │    │    Port 1099    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 启动顺序

1. **数据库服务**: 启动MySQL主从服务器
2. **缓存服务**: 启动Redis服务器
3. **消息队列**: 启动RabbitMQ服务器
4. **应用服务**: 启动Spring Boot应用
5. **负载均衡**: 启动Nginx服务

## 监控端点

- **健康检查**: `http://localhost:9090/api/loadbalancer/health`
- **系统概览**: `http://localhost:9090/api/component/visualization/overview`
- **缓存统计**: `http://localhost:9090/api/cache/stats`
- **消息队列**: `http://localhost:9090/api/mq/stats`
- **数据源状态**: `http://localhost:9090/api/datasource/health`

## 技术栈

- **后端框架**: Spring Boot 3.5.3
- **数据库**: MySQL 8.0 + MyBatis Plus
- **缓存**: Redis + Spring Cache
- **消息队列**: RabbitMQ
- **负载均衡**: Nginx
- **远程调用**: Java RMI
- **文档**: Swagger/Knife4j
- **构建工具**: Maven

## 注意事项

1. **网络配置**: 确保所有服务器之间网络互通
2. **防火墙**: 开放必要的端口 (80, 9090, 3306, 6379, 5672, 1099)
3. **数据库同步**: 确保MySQL主从复制正常工作
4. **服务依赖**: 按顺序启动各个服务
5. **监控告警**: 配置适当的监控和告警机制

## 扩展功能

系统支持以下扩展功能：
- Docker容器化部署
- Kubernetes集群部署
- 微服务注册发现 (Eureka/Consul)
- 配置中心 (Spring Cloud Config)
- 链路追踪 (Zipkin/Jaeger)
- 监控告警 (Prometheus/Grafana)

